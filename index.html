<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>When You Breathe — Tap Mandala</title>
<style>
  :root{
    --diam: min(86vmin, 560px);
    --inhale: 4.5s; --hold: 1s; --exhale: 5.5s;   /* edit pacing here */
    --bg:#0b0f1a; --ink:#d9dbe6;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Segoe UI,Arial}
  .wrap{min-height:100%;display:grid;place-items:center;padding:14px;gap:12px}
  .mandala{width:var(--diam);height:var(--diam);border-radius:50%;position:relative;overflow:hidden;box-shadow:0 0 40px #000 inset,0 0 50px #000;cursor:pointer;touch-action:manipulation}
  #art{position:absolute;inset:0;background:#111 center/cover no-repeat;filter:contrast(1.06) saturate(1.03)}
  #glow{position:absolute;inset:0;border-radius:50%;box-shadow:0 0 24px 6px rgba(255,220,120,.18)}
  .pulse{animation:breath calc(var(--inhale) + var(--hold) + var(--exhale)) ease-in-out infinite}
  @keyframes breath{0%{transform:scale(1)}45%{transform:scale(1.08)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .bar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  button,input[type="file"]{background:#141b2d;color:#e6ecff;border:1px solid #2a3556;border-radius:8px;padding:.55em .9em}
  .hint{font-size:14px;opacity:.9;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div id="mandala" class="mandala" aria-label="Tap to start / stop breathing">
    <div id="art" role="img" aria-label="Breath mandala"></div>
    <div id="glow"></div>
  </div>
  <div class="bar">
    <input id="picker" type="file" accept="image/*" />
    <button id="toggle">start</button>
    <button id="pace">pace: 4.5 · 1 · 5.5</button>
    <button id="sound">sound: on</button>
  </div>
  <div id="hint" class="hint">choose your mandala image (PNG/JPG), then tap the circle to breathe</div>
</div>
<script>
(() => {
  const root = document.documentElement;
  const art = document.getElementById('art');
  const glow = document.getElementById('glow');
  const mandala = document.getElementById('mandala');
  const picker = document.getElementById('picker');
  const toggle = document.getElementById('toggle');
  const paceBtn = document.getElementById('pace');
  const soundBtn = document.getElementById('sound');
  const hint = document.getElementById('hint');

  // timings
  const getS = n => parseFloat(getComputedStyle(root).getPropertyValue(n)) * 1000;
  function setCycle(){ const c = getS('--inhale') + getS('--hold') + getS('--exhale'); root.style.setProperty('--cycle', c + 'ms'); return c; }
  let cycle = setCycle();

  // audio cues
  let audioOn = true, ctx;
  soundBtn.onclick = () => { audioOn = !audioOn; soundBtn.textContent = 'sound: ' + (audioOn?'on':'off'); };
  const tone = (freq, ms) => {
    if (!audioOn) return;
    ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator(), g = ctx.createGain();
    osc.frequency.value = freq; osc.type = 'sine';
    g.gain.value = 0.0001; g.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 0.08);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + ms/1000);
    osc.connect(g).connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + ms/1000 + .02);
  };

  // swap pace
  paceBtn.onclick = () => {
    const current = getS('--inhale')/1000;
    if (current < 5) { root.style.setProperty('--inhale','5.5s'); root.style.setProperty('--exhale','6.5s'); root.style.setProperty('--hold','1.5s'); }
    else { root.style.setProperty('--inhale','4.5s'); root.style.setProperty('--exhale','5.5s'); root.style.setProperty('--hold','1.0s'); }
    cycle = setCycle(); if (running) { stop(); start(); }
    paceBtn.textContent = `pace: ${(+getS('--inhale')/1000)} · ${(+getS('--hold')/1000)} · ${(+getS('--exhale')/1000)}`;
  };

  // load saved image if present
  const saved = localStorage.getItem('mandala-src');
  if (saved) { art.style.backgroundImage = `url(${saved})`; hint.textContent = 'tap the circle to begin · inhale with the glow · exhale as it softens'; }

  picker.addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = ev => {
      const src = ev.target.result;
      art.style.backgroundImage = `url(${src})`;
      localStorage.setItem('mandala-src', src);
      hint.textContent = 'tap the circle to begin · inhale with the glow · exhale as it softens';
    };
    r.readAsDataURL(file);
  });

  // breathing loop
  let running = false, timer;
  function loop(){
    const inhale = getS('--inhale'), hold = getS('--hold'), exhale = getS('--exhale');
    tone(432, 360); navigator.vibrate?.(10);                         // inhale cue
    setTimeout(()=>{ tone(528, 200); navigator.vibrate?.(6); }, inhale);           // hold cue
    setTimeout(()=>{ tone(396, 360); navigator.vibrate?.(8); }, inhale + hold);    // exhale cue
    timer = setTimeout(loop, cycle);
  }
  function start(){ if(running) return; running=true; glow.classList.add('pulse'); toggle.textContent='pause'; hint.textContent='tap to pause · the world is breathing with you'; loop(); }
  function stop(){ running=false; glow.classList.remove('pulse'); toggle.textContent='start'; hint.textContent='choose your mandala image (PNG/JPG), then tap the circle to breathe'; clearTimeout(timer); }

  mandala.addEventListener('click', ()=> running?stop():start(), {passive:true});
  toggle.addEventListener('click', ()=> running?stop():start());
})();
</script>
</body>
</html>
